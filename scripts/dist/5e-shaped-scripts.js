!function(e){function t(e){return e.charAt(0).toUpperCase()+e.slice(1)}function a(t){if(U=t.who,e.settings.useAmmoAutomatically&&"5eDefault"===t.rolltemplate&&-1!==t.content.indexOf("{{ammo_auto=1}}")){for(var a,i,r,s=/\{\{(.*?)\}\}/gi;r=s.exec(t.content);)if(r[1]){var n=r[1].split("=");"character_name"===n[0]&&(a=n[1]),"ammo_field"===n[0]&&(i=n[1])}e.decrementAmmo(a,i)}if("api"===t.type){log("msg.content: "+t.content);var o=t.content.split(/\s+--/);switch(o[0]){case"!build-monster":case"!shaped-parse":case"!shaped-import":o[1]&&"clean"===o[1]&&e.getSelectedToken(t,e.deleteOldSheet),e.getSelectedToken(t,e.importStatblock);break;case"!shaped-rollhp":e.getSelectedToken(t,e.rollTokenHp);break;case"!shaped-settings":o.shift(),e.changeSettings(o);break;case"!shaped-spell":o.shift(),e.getSelectedToken(t,e.spellImport,o);break;case"!shaped-monster":o.shift(),e.getSelectedToken(t,e.monsterImport,o);break;case"!shaped-token":e.getSelectedToken(t,e.tokenMacros,o)}}}function i(e){log(e),sendChat("Shaped","/w gm "+e),U&&-1===U.indexOf("(GM)")&&sendChat("Shaped","/w "+U+" "+e)}function r(e){return e.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})}function s(t){d("Init","","%{"+t+"|Initiative}",e.settings.createAbilityAsToken)}function n(t){d("Save","","%{"+t+"|save_query_macro}",e.settings.createAbilityAsToken)}function o(t){d("Check","","%{"+t+"|check_query_macro}",e.settings.createAbilityAsToken)}function l(){"hidden"===e.settings.sheetOutput&&g("output_option","@{output_to_gm}"),e.settings.whisperDeathSaves&&g("death_save_output_option","@{output_to_gm}"),e.settings.whisperInitiative&&g("initiative_output_option","@{output_to_gm}"),e.settings.showCharacterNameOnRollTemplate&&g("show_character_name","@{show_character_name_yes}"),e.settings.initiativeTieBreaker&&g("initiative_tie_breaker","((@{initiative_overall}) / 100)"),e.settings.initiativeAddsToTracker&&g("initiative_to_tracker","@{initiative_to_tracker_yes}"),e.settings.attacksVsTargetAC&&g("attacks_vs_target_ac","@{attacks_vs_target_ac_yes}"),e.settings.attacksVsTargetName&&g("attacks_vs_target_name","@{attacks_vs_target_name_yes}"),e.settings.hideGMInfo&&(g("hide_save_dc","@{hide_save_dc_var}"),g("hide_save_failure","@{hide_save_failure_var}"),g("hide_save_success","@{hide_save_success_var}"),g("hide_effects","@{hide_effects_var}"),g("hide_recharge","@{hide_recharge_var}"))}function c(e,t){return e-t}function g(e,t,a){if(!e)throw"Name required to set attribute";if(a=a||"",!t)return void i("Error setting empty value: "+e);var r=findObjs({_type:"attribute",_characterid:q,name:e})[0];r?r.get("current")&&r.get("current").toString()===t||r.set({current:t,max:a}):createObj("attribute",{name:e,current:t,max:a,characterid:q})}function d(e,t,a,i){if(!e)throw"Name required to set ability";var r=findObjs({_type:"ability",_characterid:q,name:e});if(!r)throw"Something prevent script to create or find ability "+e;0===r.length?r=createObj("ability",{_characterid:q,name:e,description:t,action:a,istokenaction:i}):(r=getObj("ability",r[0].id),r.get("description")==t&&r.get("action")===a&&r.get("istokenaction")==i||r.set({description:t,action:a,istokenaction:i}))}function h(e){return unescape(e).replace(/\s\./g,".").replace(/–/g,"-").replace(/<br[^>]*>/g,"#").replace(/\s*#\s*/g,"#").replace(/(<([^>]+)>)/gi,"").replace(/#(?=[a-z]|DC)/g," ").replace(/\s+/g," ").replace(/#Hit:/gi,"Hit:").replace(/Hit:#/gi,"Hit: ").replace(/#Each /gi,"Each ").replace(/#On a successful save/gi,"On a successful save").replace(/DC#(\d+)/g,"DC $1").replace("LanguagesChallenge","Languages -#Challenge").replace("' Speed","Speed").replace(/#Medium or/gi," Medium or").replace(/take#(\d+)/gi,"take $1")}function p(e){"string"!=typeof e&&(e=e.toString()),e=e.replace(/\,\./gi,",").replace(/ft\s\./gi,"ft.").replace(/ft\.\s\,/gi,"ft").replace(/ft\./gi,"ft").replace(/(\d+) ft\/(\d+) ft/gi,"$1/$2 ft").replace(/lOd/g,"10d").replace(/dl0/gi,"d10").replace(/dlO/gi,"d10").replace(/dl2/gi,"d12").replace(/Sd(\d+)/gi,"5d$1").replace(/ld(\d+)/gi,"1d$1").replace(/ld\s+(\d+)/gi,"1d$1").replace(/(\d+)d\s+(\d+)/gi,"$1d$2").replace(/(\d+)\s+d(\d+)/gi,"$1d$2").replace(/(\d+)\s+d(\d+)/gi,"$1d$2").replace(/(\d+)d(\d)\s(\d)/gi,"$1d$2$3").replace(/(\d+)j(?:Day|day)/gi,"$1/Day").replace(/(\d+)f(?:Day|day)/gi,"$1/Day").replace(/(\d+)j(\d+)/gi,"$1/$2").replace(/(\d+)f(\d+)/gi,"$1/$2").replace(/{/gi,"(").replace(/}/gi,")").replace(/(\d+)\((\d+) ft/gi,"$1/$2 ft").replace(/• /gi,"").replace(/’/gi,"'"),e=e.replace(/(\d+)\s*?plus\s*?((?:\d+d\d+)|(?:\d+))/gi,"$2 + $1");var t={jday:"/day","abol eth":"aboleth","ACT IONS":"ACTIONS",Afrightened:"A frightened",Alesser:"A lesser","Athl etics":"Athletics",Aundefinedr:"After","blindn ess":"blindness","blind sight":"blindsight",bofh:"both","brea stplate":"breastplate","choos in g":"choosing","com muni cate":"communicate","Constituti on":"Constitution","creatu re":"creature","darkvi sion":"darkvision","dea ls":"deals","di sease":"disease","di stance":"distance","fa lls":"falls","fe et":"feet","exha les":"exhales","ex istence":"existence",lfthe:"If the",Ifthe:"If the",lnt:"Int","magica lly":"magically",minlilte:"minute","natura l":"natural",ofeach:"of each",ofthe:"of the","on'e":"one","0n":"on","pass ive":"passive","Perce ption":"Perception","radi us":"radius","ra nge":"range","rega ins":"regains","rest.oration":"restoration","savin g":"saving","si lvery":"silvery","s lashing":"slashing","slas hing":"slashing","slash in g":"slashing","slash ing":"slashing","Spel/casting":"Spellcasting","successfu l":"successful","ta rget":"target"," Th e ":" The ",t_urns:"turns","unti l":"until","withi n":"within"},a=new RegExp(Object.keys(t).join("|"),"gi");return e=e.replace(a,function(e){return t[e]})}function u(e){for(var t={attr:{},traits:{},actions:{},lair:{},legendary:{},reactions:{}},a=0,i=e.length,r=e.length,s=e.length,n=/#\s*(tiny|small|medium|large|huge|gargantuan|armor class|hit points|speed|str|dex|con|int|wis|cha|saving throws|skills|damage resistances|damage immunities|condition immunities|damage vulnerabilities|senses|languages|challenge|traits|actions|lair actions|legendary actions|reactions)(?=\s|#)/gi;l=n.exec(e);){var o=l[1].toLowerCase();"actions"===o?(a=l.index,t.actions.Actions=l.index):"legendary actions"===o?(r=l.index,t.legendary.Legendary=l.index):"reactions"===o?(s=l.index,t.reactions.Reactions=l.index):"lair actions"===o?(i=l.index,t.lair.Lair=l.index):t.attr[o]=l.index}n=/(?:#)([A-Z][\w-\']+(?:\s(?:[A-Z][\w-\']+|[\(\)\/\d\-]|of|and|or|a)+)*)(?=\s*\.)/gi,log("parsed statblock: "+e);for(var l;l=n.exec(e);)t.attr[l[1].toLowerCase()]||(l.index<a?t.traits[l[1]]=l.index:l.index>a&&l.index<r&&l.index<s&&l.index<i?t.actions[l[1]]=l.index:l.index>r&&l.index<s&&l.index<i?t.legendary[l[1]]=l.index:l.index>s&&l.index<i?t.reactions[l[1]]=l.index:l.index>i&&(t.lair[l[1]]=l.index));var g=e.split("#"),d="",h=[],_=1;for(var p in t.actions)t.actions.hasOwnProperty(p)&&h.push(t.actions[p]);for(var u in t.legendary)t.legendary.hasOwnProperty(u)&&h.push(t.legendary[u]);for(var m in t.lair)t.lair.hasOwnProperty(m)&&h.push(t.lair[m]);h.sort(c);for(var f,v=h[h.length-1]+1;6>_;)d=g[g.length-_],f=e.indexOf(d),f>v&&(t.traits.Description=f-1),_++;return t}function m(e,t){var a,i,r,s=[];for(a in t)if(t.hasOwnProperty(a)){i=t[a];for(r in i)i.hasOwnProperty(r)&&s.push(i[r])}s.sort(c),t.attr.name=f(e.substring(0,s[0]),"name");for(a in t)if(t.hasOwnProperty(a)){i=t[a];for(r in i)if(i.hasOwnProperty(r)){var n=i[r],o=s.indexOf(n)+1,l=s[o]||e.length;t[a][r]=f(e.substring(n,l),r)}}delete t.actions.Actions,delete t.legendary.Legendary,delete t.reactions.Reactions;for(var g=["str","dex","con","int","wis","cha"],d="",h=0,_=g.length;_>h;++h)t.attr.hasOwnProperty([g[h]])&&(d+=t.attr[g[h]]+" ",delete t.attr[g[h]]);t.attr.abilities=d;var p=["tiny","small","medium","large","huge","gargantuan"];for(h=0,_=p.length;_>h;++h)if(t.attr.hasOwnProperty([p[h]])){t.attr.size=p[h]+" "+t.attr[p[h]],delete t.attr[p[h]];break}return t}function f(e,t){return e.replace(new RegExp("^[\\s\\.#]*"+t.replace(/([-()\\/])/g,"\\$1")+"?[\\s\\.#]*","i"),"").replace(/#/g," ")}function v(e){e.attr.abilities&&y(e.attr.abilities),e.attr.size&&k(e.attr.size),e.attr["armor class"]&&w(e.attr["armor class"]),e.attr["hit points"]&&A(e.attr["hit points"]),e.attr.speed&&O(e.attr.speed),e.attr.challenge&&S(e.attr.challenge),e.attr["saving throws"]&&N(e.attr["saving throws"]),e.attr.skills&&D(e.attr.skills),e.attr.senses&&T(e.attr.senses),e.attr["damage immunities"]&&g("damage_immunity",e.attr["damage immunities"]),e.attr["condition immunities"]&&g("condition_immunity",e.attr["condition immunities"]),e.attr["damage vulnerabilities"]&&g("damage_vulnerability",e.attr["damage vulnerabilities"]),e.attr["damage resistances"]&&g("damage_resistance",e.attr["damage resistances"]),e.attr.languages&&g("prolanguages",e.attr.languages),E(e.traits),M(e.reactions),R(e.actions),R(e.legendary,"legendary_"),R(e.lair,"lair_")}function y(e){for(var t,a=/(\d+)\s*\(/g,i=[];t=a.exec(e);)i.push(t[1]);G.strength=i[0],G.dexterity=i[1],G.constitution=i[2],G.intelligence=i[3],G.wisdom=i[4],G.charisma=i[5],g("strength",i[0]),g("dexterity",i[1]),g("constitution",i[2]),g("intelligence",i[3]),g("wisdom",i[4]),g("charisma",i[5])}function b(e){for(var t,a=/(\d+)/g,i=[];t=a.exec(e);)i.push(t[1]);G.strength=i[0],G.dexterity=i[1],G.constitution=i[2],G.intelligence=i[3],G.wisdom=i[4],G.charisma=i[5],g("strength",i[0]),g("dexterity",i[1]),g("constitution",i[2]),g("intelligence",i[3]),g("wisdom",i[4]),g("charisma",i[5])}function k(e){var t=e.match(/(.*?) (.*?), (.*)/i);if(!(t&&t[1]&&t[2]&&t[3]))throw"Character doesn't have valid type/size/alignment format";g("size",r(t[1])),g("npc_type",r(t[2])),g("alignment",r(t[3]))}function w(e){var t=e.match(/(\d+)\s?(.*)/);if(!t||!t[1])throw"Character doesn't have valid AC format";g("npc_AC",t[1]),t[2]&&g("npc_AC_note",t[2].replace(/\(|\)/g,""))}function x(e){for(var t,a=/(\d+)d(\d+)/gi;t=a.exec(e);){if(!t||!t[1]||!t[2])throw"Character doesn't have valid hd format";var i=t[1],r="d"+t[2];g("hd_"+r,i,i),g("hd_"+r+"_toggle","on")}}function A(e){var t=e.match(/(\d+)\s?\(([\dd\s\+\-]*)\)/i);if(!t||!t[1]||!t[2])throw"Character doesn't have valid HP/HD format";g("HP",t[1],t[1]),g("npc_HP_hit_dice",t[2]),x(t[2])}function O(e){for(var t,a="speed",i=/(|burrow|climb|fly|swim|)\s*(\d+)\s*?(?:ft)?\s*(\(.*\))?/gi;t=i.exec(e);){if(!t[2])throw"Character doesn't have valid speed format";var r=a+(""!==t[1]?"_"+t[1].toLowerCase():""),s=t[2];t[3]&&t[3].indexOf("hover")&&g("speed_fly_hover","on"),g(r,s)}}function T(e){e=e.replace(/[,\s]*passive.*/i,"");for(var t,a=/(blindsight|darkvision|tremorsense|truesight)\s*?(\d+)\s*?ft?\s*(\(.*\))?/gi;t=a.exec(e);){if(!t||!t[1]||!t[2])throw"Character doesn't have valid senses format";var i=t[1].toLowerCase(),r=t[2];e.indexOf("blind beyond")&&g("blindsight_blind_beyond","on"),g(i,r)}}function C(e){var t,a,i=parseInt(getAttrByName(q,"blindsight"),10)||0,r=parseInt(getAttrByName(q,"darkvision"),10)||0,s=parseInt(getAttrByName(q,"tremorsense"),10)||0,n=parseInt(getAttrByName(q,"truesight"),10)||0,o=Math.max(i,r,s,n),l=Math.max(i,s,n);o===i?(t=i,a=i):o===s?(t=s,a=s):o===n?(t=n,a=n):o===r&&(t=Math.ceil(1.1666666*r),a=l>0?l:-5),t>0&&e.set("light_radius",t),a&&e.set("light_dimradius",a),e.set("light_hassight",!0),e.set("light_angle",360),e.set("light_losangle",360)}function S(e){var t=e.replace(/[, ]/g,""),a=t.match(/([\d\/]+).*?(\d+)/);L(a[1]);var i=parseInt(a[2]);getAttrByName(q,"xp")!==i&&g("xp",i)}function L(e){G.challenge=e,Q.pb=2+Math.floor(Math.abs((e-1)/4)),g("challenge",e)}function N(e){for(var t,a,i=/(STR|DEX|CON|INT|WIS|CHA).*?(\d+)/gi;a=i.exec(e);){switch(a[1].toLowerCase()){case"str":t="strength";break;case"dex":t="dexterity";break;case"con":t="constitution";break;case"int":t="intelligence";break;case"wis":t="wisdom";break;case"cha":t="charisma"}g(t+"_save_prof","@{PB}");var r=parseInt(a[2],10)||0,s=parseInt(G[t])||10,n=Math.floor((s-10)/2),o=r-Q.pb-n;0!==o&&g(t+"_save_bonus",o)}}function D(e){for(var t,a={acrobatics:"dexterity","animal handling":"wisdom",arcana:"intelligence",athletics:"strength",deception:"charisma",history:"intelligence",insight:"wisdom",intimidation:"charisma",investigation:"intelligence",medicine:"wisdom",nature:"intelligence",perception:"wisdom",performance:"charisma",persuasion:"charisma",religion:"intelligence","sleight of hand":"dexterity",stealth:"dexterity",survival:"wisdom"},i={"alchemist's supplies":"intelligence","navigator's tools":"wisdom","thieves' tools":"dexterity"},s=/([\w\s\']+).*?(\d+)/gi,n=0;t=s.exec(e.replace(/Skills\s+/i,""));){var o,l,c,d=t[1].trim().toLowerCase(),h=2*Q.pb;d in a?(o=a[d],l=d.replace(/\s/g,""),c=t[2]-Math.floor((getAttrByName(q,o)-10)/2),c>=h?(g(l+"_prof_exp","@{exp}"),c>h&&g(l+"_bonus",c-h)):c>=Q.pb?(g(l+"_prof_exp","@{PB}"),c>Q.pb&&g(l+"_bonus",c-Q.pb)):(g(l+"_prof_exp","@{jack_of_all_trades}"),c>0&&g(l+"_bonus",c))):d in i?(n++,o=i[d],l="custom_skill_"+n,c=t[2]-Math.floor((getAttrByName(q,o)-10)/2),g(l+"_name",r(d)),log("added "+r(d)+" to custom skills"),c>=h?(g(l+"_prof_exp","@{exp}"),c>h&&g(l+"_bonus",c-h)):c>=Q.pb?(g(l+"_prof_exp","@{PB}"),c>Q.pb&&g(l+"_bonus",c-Q.pb)):(g(l+"_prof_exp","@{jack_of_all_trades}"),c>0&&g(l+"_bonus",c))):B.push("Skill "+d+" is not a valid skill"),n>0&&g("custom_skills_toggle","on")}}function E(e){var t=[];if(_.each(e,function(e,a){t.push("**"+a+"**. "+e)}),t.length>0){var a=t.join("\n");g("npc_traits",a)}}function M(e){var t=[];_.each(e,function(e,a){t.push("**"+a+"**. "+e)}),t.length>0&&(g("reactions",t.join("\n")),g("toggle_reactions","on"))}function I(t,a){function i(e,t,i){"undefined"==typeof i&&(i=t),i&&g("repeating_"+a+"actions_"+L+"_"+e,t.trim())}function s(e,t){("undefined"==typeof t||t)&&g("repeating_"+a+"actions_"+L+"_toggle_"+e,"@{repeating_"+a+"actions_"+L+"_var_"+e+"}")}function n(e){return e.replace(/\s?[\+\-]\s?\d+/g,"")}function o(e){i("name",e)}function l(e){i("type",e)}function c(e){i("target",e),s("target")}function h(e){i("range",e),s("range")}function p(e,t){i(t+"dmg",e)}function u(e){s(e+"damage")}function m(e,t){i(t+"dmg_type",e)}function f(e,t){i(t+"crit_dmg",e)}function v(e){i("alt_dmg_reason",e)}function y(e){e&&i("effect",e.replace(/(\s*?Hit:\s?)/gi,"").replace(/(\d+)d(\d+)/g,"[[$1d$2]]").replace(/\s(\d+)\s/g," [[$1]] ")),s("effects",e)}function b(e){i("save_dc",e)}function k(e){e&&i("save_stat",e.substring(0,3))}function w(e){s("save",e)}function x(e){s("save_damage",e)}function A(e){i("save_dmg",e)}function O(e){i("save_dmg_type",e)}function T(e){i("save_success",e)}function C(e){y(e)}function S(e,t){e&&(e[1]&&(e[2]=e[1]),e[2]&&(p(e[2],t),f(n(e[2]),t)),e[4]&&(e[3]+=" "+e[4]),e[3]&&m(e[3],t),(e[2]||e[3])&&u(t),e[5]&&y(e[5].trim()),e[6]&&v(e[6]))}var L=0,N=[],D=[];a||(a="");var E=/\,?\.?\s*?/,M=/\,?\.?\s*/,I=/\,?\.?\s?/,j=/Hit:.*?/,R=/((?:[\w]+|[\w]+\s(?:or|and)\s[\w]+)(?:\s*?\([\w\s]+\))?)\s*?damage\s?(\([\w\'\s]+\))?/,P=/(?:(\d+)|.*?\(([\dd\s\+\-]*)\).*?)\s*?/,H=/(?:\,\s*?or\s*?)/,$=/((?:if|in)[\w\s]+)/,B=/(The.*|If the.*)?/,q=/\s*?plus\s*?/,U=/(?:DC)\s*?(\d+)\s*?([a-zA-Z]*)\s*?(?:saving throw)/,G=/\,?\s*?(?:taking|or take)/,Q=/(?: against disease)?/,V=/(?:.*or\s(.*)?\son a successful one.)?/,F=/(?:On a successful save,)?(.*)?/,Z=/(?:On a (?:failure|failed save))\,\s(?:(.*). On a success,\s(.*)?)?(.*)?/,J=/(\s?and.*)?/,W=/(or\s(?!take).*)/,X=/(.*)?/,K=new RegExp(j.source+P.source+R.source+E.source+J.source,"i"),Y=new RegExp(q.source+P.source+R.source+E.source+X.source,"i"),ee=new RegExp(H.source+P.source+R.source+E.source+$.source+I.source+B.source,"i"),te=new RegExp(j.source+X.source,"i"),ae=new RegExp(U.source+G.source+P.source+R.source+V.source+E.source+X.source+F.source,"i"),ie=new RegExp(U.source+Q.source+M.source+W.source,"i"),re=new RegExp(U.source+E.source+Z.source,"i");return _.each(t,function(t,n){function g(){d(n,"","%{"+z+"|repeating_"+a+"actions_"+L+"_action}",e.settings.createAbilityAsToken)}var _,p=!1,u=!1,m=!1,f=n.indexOf("(");f>1?N[L]=n.substring(0,f-1).toLowerCase():N[L]=n.toLowerCase();for(var v,E=/\s*?\((?:Recharge\s*?(\d+\-\d+|\d+)|Recharges\safter\sa\s(.*))\)/gi;v=E.exec(n);){var M=v[1]||v[2];i("recharge",M),s("recharge"),M&&(n=n.replace(E,""))}for(var I,j=/\s*?\((\d+\/Day)\)/gi;I=j.exec(n);){var R=I[1]||I[2];i("recharge",R),s("recharge"),R&&(n=n.replace(j,""),n=n.replace(j,""))}o(n);for(var P,H=t.split(/\.(.+)?/),$=H[0],B=$.split(","),q=/(melee|ranged|melee or ranged)\s*(spell|weapon)\s*/gi;P=q.exec(B[0]);){if(P[1]){var U="Melee or Ranged";P[1].toLowerCase()===U.toLowerCase()&&(P[1]="Thrown"),l(r(P[1]))}p=!0}for(var G,Q=/\+\s?(\d+)\s*(?:to hit)/gi;G=Q.exec(B[0]);)G[1]&&(i("tohit",G[1]),s("attack"),s("crit")),B[2]&&c(B[2].trim().toLowerCase()),p=!0;for(var V,F=/(?:reach)\s?(\d+)\s?(?:ft)/gi;V=F.exec(B[1]);)V[1]&&(i("reach",V[1]+" ft",V[1]),s("reach")),p=!0;for(var Z,J=/(?:range)\s?(\d+)\/(\d+)\s?(ft)/gi;Z=J.exec(B[1]);)Z[1]&&Z[2]&&h(Z[1]+"/"+Z[2]+" ft"),p=!0;var W=K.exec(t);if(W)S(W,"");else{var X=te.exec(t);X&&X[1]&&y(X[1].trim())}var se=Y.exec(t);se&&S(se,"second_");var ne=ee.exec(t);ne&&(ne[6]=[ne[5],ne[5]=ne[6]][0],S(ne,"alt_")),W=K.exec(t),oe&&S(W,"");var oe=ae.exec(t);oe&&(oe[1]&&b(oe[1]),oe[2]&&k(oe[2]),oe[3]&&(oe[4]=oe[3]),oe[4]&&A(oe[4]),oe[6]&&(oe[5]+=" "+oe[6]),oe[5]&&O(oe[5]),oe[9]&&(oe[7]=oe[9]),oe[7]&&T(oe[7]),oe[8]&&C(oe[8]),(oe[1]||oe[2]||oe[8])&&w(),(oe[4]||oe[5]||oe[7])&&x(),u=!0);var le=ie.exec(t);le&&(le[1]&&b(le[1]),le[2]&&k(le[2]),le[3]&&C(le[3]),(le[1]||le[2]||le[3])&&w(),u=!0);var ce=re.exec(t);ce&&(ce[1]&&b(ce[1]),ce[2]&&k(ce[2]),ce[5]&&(ce[3]=ce[5]),ce[3]&&C(ce[3]),ce[4]&&T(ce[4]),(ce[1]||ce[2]||ce[3]||ce[4])&&w(),u=!0);for(var ge,de=/((?:Each | a | an | one ).*(?:creature|target).*)\s(?:within|in)\s*?a?\s*?(\d+)\s*?(?:feet|ft)/gi;ge=de.exec(t);)ge[1]&&c(ge[1].trim()),ge[2]&&h(ge[2]+" ft",ge[2]);var he=/(\d+)\-foot line\s*?that is (\d+) feet wide/gi,_e=he.exec(t),pe=/line that is (\d+)\sfeet long\s*?and (\d+) feet wide/gi,ue=pe.exec(t),me=_e||ue;me&&(l("Line"),me[1]&&me[2]?h(me[1]+"-foot line that is "+me[2]+" feet wide"):me[1]&&h(me[1]));for(var fe,ve=/\.\s*(.*in that line)/gi;fe=ve.exec(t);)c(fe[1]);_=p||m||u,_?("legendary_"===a&&D.push(n+". See below"),n.indexOf("Costs ")>0&&(n=n.replace(/\s*\(Costs\s*\d+\s*Actions\)/gi,""),o(n)),g(),L++):"legendary_"===a?D.push(n+". "+t):(y(t),g(),L++)}),D.length>0&&g("legendary_action_notes",D.join("\n")),N}function j(e,t){return""!==t&&(t+="\n"),t+="%{"+z+"|repeating_actions_"+e+"_action}"}function R(t,a){a||(a="");var i;e.settings.addInitiativeTokenAbility&&s(z),e.settings.addSaveQueryMacroTokenAbility&&n(z),e.settings.addCheckQueryMacroTokenAbility&&o(z);var r;for(var l in t){r=/Multiattack(?:\s*(\(.*\)))?/gi;var c=r.exec(l);if(i="",c){c[1]&&(i=c[1]+": "),i+=t[l],g("multiattack",i),delete t[l],g("toggle_multiattack","on"),d("MultiAtk","","%{"+z+"|multiattack}",e.settings.createAbilityAsToken);break}}var h=I(t,a);if("lair_"===a&&Object.keys(t).length>0&&g("toggle_lair_actions","on"),"legendary_"===a&&Object.keys(t).length>0&&g("toggle_legendary_actions","on"),i){var _=h.join("|");r=new RegExp("(one|two|three)? (?:with its )?("+_+")( or)?","gi");for(var p,u,m="";u=r.exec(i);){var f=u[2],v=u[1]||"one";p=h.indexOf(f.toLowerCase()),-1!==p&&(m=j(p,m),"two"==v&&(m=j(p,m)),"three"==v&&(m=j(p,m)),u[3]&&(m+="or\n"),delete h[p])}g("multiattack_script",m)}}function P(e,t){e.set(t+"_link",""),e.set(t+"_value",""),e.set(t+"_max","")}function H(t){for(var a=0;3>a;a++){var i=e.settings.bar[a].name,r="bar"+(a+1);if(""!==i){var s,n,o,l=findObjs({name:i,_type:"attribute",_characterid:q},{caseInsensitive:!0})[0];l?(s=l.id,n=l.attributes.current,o=l.attributes.max):s="sheetattr_"+i,e.settings.bar[a].link?t.set(r+"_link",s):t.get(r+"_link")&&(log(r+": link isn't set in the bar settings, clearing link"),t.set(r+"_link","")),i?t.set(r+"_value",n):t.get(r+"_value")&&(log(r+": current isn't set in the bar settings, clearing current"),t.set(r+"_value","")),e.settings.bar[a].max?t.set(r+"_max",o):t.get(r+"_max")&&(log(r+": max isn't set in the bar settings, clearing max"),t.set(r+"_max",""))}else log(r+": no defined bar setting in shaped-scripts (at the top of the page), clearing "+r+"."),P(t,r)}}e.settings={createAbilityAsToken:!0,rollMonsterHpOnDrop:!0,showName:!0,showNameToPlayers:!1,showCharacterNameOnRollTemplate:!1,sheetOutput:"",whisperDeathSaves:!0,initiativeTieBreaker:!0,whisperInitiative:!0,initiativeAddsToTracker:!0,addInitiativeTokenAbility:!0,attacksVsTargetAC:!1,attacksVsTargetName:!1,addSaveQueryMacroTokenAbility:!0,addCheckQueryMacroTokenAbility:!0,useAmmoAutomatically:!0,bar:[{name:"npc_AC",max:!1,link:!0,show:!1},{name:"",max:!1,link:!1,show:!1},{name:"HP",max:!0,link:!1,show:!1}]},e.statblock={version:"April 20th, 2016",addTokenCache:[],RegisterHandlers:function(){on("chat:message",a),e.settings.rollMonsterHpOnDrop&&(on("add:graphic",function(t){e.statblock.addTokenCache.push(t.id)}),on("change:graphic",function(t){e.rollTokenHpOnDrop(t)})),log("Shaped Scripts ready")}};var $="",B=[],q=null,z=null,U=null,G={},Q={};e.getSelectedToken=e.getSelectedToken||function(e,t){try{if(!e.selected||!e.selected.length)throw"No token selected";for(var a=0;a<e.selected.length;a++)if("graphic"===e.selected[a]._type){var r=getObj("graphic",e.selected[a]._id);r&&"token"===r.get("subtype")&&t(r,arguments[2])}}catch(s){i("Exception: "+s)}},e.deleteOldSheet=function(e){var t=e.get("represents"),a=findObjs({_type:"character",id:t})[0];a&&(a.remove(),log("old sheet removed before importing"))},e.deleteOldSheetByName=function(e){var t=findObjs({_type:"character",name:e})[0];t&&(t.remove(),log("old sheet removed before importing"))},e.tokenMacros=function(e,t){var a=e.get("represents");character=findObjs({_type:"character",id:a})[0];var r=getAttrByName(a,"character_name","current");return"undefined"==typeof character?void i('Error: cannot find a character by the name of "'+r+'".'):(q=character.id,void("init"===t[1]?(s(r),i("created init token macro for "+r+".")):"query"===t[1]?(n(r),o(r),i("created query token macros for "+r+".")):(s(r),n(r),o(r),i("bootstraped all token macros for "+r+"."))))},e.decrementAmmo=function(e,t){var a=findObjs({_type:"character",name:e})[0],i=findObjs({_type:"attribute",_characterid:a.id,name:t})[0],r=parseInt(i.get("current"),10)||0;i.set({current:r-1})},e.rollTokenHpOnDrop=function(t){U=null,_.contains(e.statblock.addTokenCache,t.id)&&"graphic"===t.get("type")&&"token"===t.get("subtype")&&(e.statblock.addTokenCache=_.without(e.statblock.addTokenCache,t.id),e.rollTokenHp(t))},e.rollTokenHp=function(t){for(var a,r=0;3>r;r++)if("HP"===e.settings.bar[r].name){a=r+1;break}if(!a)return void i('One of the bar names has to be set to "HP" for random HP roll');var s="bar"+a,n=t.get("represents");if(""===n)i("Token does not represent a character");else if(""!==t.get(s+"_link"))i("Token "+s+" is linked");else{var o=getAttrByName(n,"is_npc","current");if(1===o||"1"===o){for(var l=[4,6,8,10,12,20],c="",g="",d=0,h=0,p=parseInt(getAttrByName(n,"constitution","current"),10),u=Math.floor((p-10)/2),m=0;m<l.length;m++){var f=parseInt(getAttrByName(n,"hd_d"+l[m],"current"),10);if(f){""!==g&&(g+=" + "),h+=f,g+=f+"d"+l[m];for(var v=0;f>v;v++)""!==c&&(c+=" + "),c+="{d"+l[m]+" + "+u+", 0d0+1}kh1",d+=l[m]/2+.5+u}}if(g+=" + "+u*h,""===c)return void i("Character does not have any hit dice, cannot roll");sendChat("Shaped","/roll "+c,function(e){var a=JSON.parse(e[0].content);_.has(a,"total")&&(t.set(s+"_value",a.total),t.set(s+"_max",a.total),i("HP ("+g+") | average: "+Math.floor(d)+" | rolled: "+a.total))})}}log("Still working after trying to roll hp")},e.setCharacter=function(e,t){if(!z)throw"Name require to get or create character";var a=findObjs({_type:"character",name:z});if(0===a.length?(a=createObj("character",{name:z,avatar:e.get("imgsrc")}),$=z+" created"):(a=getObj("character",a[0].id),$=z+" updated"),!a)throw"Something prevent script to create or find character "+z;return t&&a.set({gmnotes:t}),q=a.id,1!==getAttrByName(q,"is_npc")&&g("is_npc",1),a},e.importStatblock=function(t){$="Nothing modified",B=[];var a=t.get("gmnotes").trim();if(""===a)throw"Selected token GM Notes was empty.";if(e.parseStatblock(t,a),q){t.set("represents",q);var r=z;e.settings.useAaronsNumberedScript&&1!==z.indexOf("%%NUMBERED%%")&&(r+=" %%NUMBERED%%"),t.set("name",r),e.settings.showName&&t.set("showname",!0),e.settings.showNameToPlayers&&t.set("showplayers_name",!0),l(),H(t),e.settings.bar[0].show&&t.set("showplayers_bar1","true"),e.settings.bar[1].show&&t.set("showplayers_bar2","true"),e.settings.bar[2].show&&t.set("showplayers_bar3","true"),C(t)}i($),B.length>0&&i("Error(s): "+B.join("\n/w GM "))},e.parseStatblock=function(t,a){log("---- Parsing statblock ----");var i=p(h(a)),s=u(i),n=m(i,s);z=r(n.attr.name.toLowerCase()),e.setCharacter(t,i.replace(/#/g,"<br>")),v(n)},e.setBars=function(e){H(e)},e.changeSettings=function(e){function t(t,a,i,r){s===t&&(s=a+"_"+t,"show"===e[2]?l[s]=i:"hide"===e[2]&&(l[s]=r))}function a(t,a,i){s===t&&("yes"===e[2]?l[s]=a:"no"===e[2]&&(l[s]=i))}function r(e,t){d.forEach(function(a){var i=findObjs({_type:"attribute",_characterid:a.id,name:t})[0];i?i.get("current")&&i.get("current").toString()===e[t]||i.set({current:e[t]}):createObj("attribute",{name:t,current:e[t],characterid:a.id})}),i(d.length>0?"changed "+t+" to "+e[t].replace("@","&#64;")+" for "+d.length+" creatures":"no creatures match those parameters")}log(e);var s,n=!1,o=!1,l={};"npcs"===e[0]?n=!0:"pcs"===e[0]?o=!0:"all"===e[0]?(n=!0,o=!0):i('invalid target. Please send "npcs", "pcs", or "all"');var c=["output_option","death_save_output_option","initiative_output_option","show_character_name","initiative_tie_breaker","initiative_to_tracker","attacks_vs_target_ac","attacks_vs_target_name","gm_info","save_dc","save_failure","save_success","effects","recharge"];-1!==c.indexOf(e[1])?s=e[1]:i("invalid attribute. Please use one of the following: "+c.join(", "));var g=["hide","show","yes","no"];if(-1===g.indexOf(e[2]))return void i("invalid value. Please use one of the following: "+g.join(", "));"output_option"!==s&&"death_save_output_option"!==s&&"initiative_output_option"!==s||("show"===e[2]?l[s]="@{output_to_all}":"hide"===e[2]&&(l[s]="@{output_to_gm}")),t("character_name","show","@{show_character_name_yes}","@{show_character_name_no}"),a("initiative_tie_breaker","((@{initiative_overall}) / 100)",""),a("initiative_to_tracker","@{initiative_to_tracker_yes}","@{initiative_to_tracker_no}"),a("attacks_vs_target_ac","@{attacks_vs_target_ac_yes}","@{attacks_vs_target_ac_no}"),a("attacks_vs_target_name","@{attacks_vs_target_name_yes}","@{attacks_vs_target_name_no}"),t("save_dc","hide","","@{hide_save_dc_var}"),t("save_failure","hide","","@{hide_save_failure_var}"),t("save_success","hide","","@{hide_save_success_var}"),t("effects","hide","","@{hide_effects_var}"),t("recharge","hide","","@{hide_recharge_var}"),"gm_info"===s&&("show"===e[2]?(l.hide_save_dc="",l.hide_save_failure="",l.hide_save_success="",l.hide_effects="",l.hide_recharge=""):"hide"===e[2]&&(l.hide_save_dc="@{hide_save_dc_var}",l.hide_save_failure="@{hide_save_failure_var}",l.hide_save_success="@{hide_save_success_var}",l.hide_effects="@{hide_effects_var}",l.hide_recharge="@{hide_recharge_var}"));var d=filterObjs(function(e){if("character"===e.get("type")){var t=parseInt(getAttrByName(e.id,"is_npc"),10);return n&&1===t||o&&0===t}return null});for(var h in l)l.hasOwnProperty(h)&&r(l,h)},e.importSpell=function(e,a,r,s){function n(e,t){e.damage&&(g(c+"spell_toggle_"+t+"_damage","@{spell_var_"+t+"_damage}"),g(c+"spell_"+t+"_dmg",e.damage)),e.damageBonus&&(g(c+"spell_toggle_bonuses","@{spell_var_bonuses}"),g(c+"spell_"+t+"_dmg_bonus",e.damageBonus)),e.castingStat&&g(c+"spell_"+t+"_dmg_stat","@{casting_stat}"),e.damageType&&g(c+"spell_"+t+"_dmg_type",e.damageType),e.secondaryDamage&&(g(c+"spell_toggle_"+t+"_second_damage","@{spell_var_"+t+"_second_damage}"),g(c+"spell_"+t+"_second_dmg",e.secondaryDamage)),e.secondaryDamageType&&g(c+"spell_"+t+"_second_dmg_type",e.secondaryDamageType),e.higherLevelDice&&(g(c+"spell_toggle_higher_lvl_query","@{higher_level_query}"),g(c+"spell_toggle_output_higher_lvl_query","@{spell_var_output_higher_lvl_query}"),g(c+"spell_"+t+"_higher_level_dmg_dice",e.higherLevelDice)),e.higherLevelDie&&g(c+"spell_"+t+"_higher_level_dmg_die",e.higherLevelDie),e.higherLevelSecondaryDice&&g(c+"spell_"+t+"_second_higher_level_dmg_dice",e.higherLevelSecondaryDice),e.higherLevelSecondaryDie&&g(c+"spell_"+t+"_second_higher_level_dmg_die",e.higherLevelSecondaryDie)}var o=fifthSpells.spells.filter(function(e){return e.name.toLowerCase()===r.toLowerCase()})[0];if(!o)return void i('Error: cannot find a spell by the name of "'+r+'".');if("undefined"==typeof e)return void i('Error: cannot find a character by the name of "'+a+'".');var l,c="repeating_spellbook";q=e.id,c+=0===o.level?"cantrip_":"level"+o.level+"_";for(var d=0;100>d;d++){var h=findObjs({_type:"attribute",_characterid:q,name:c+d+"_spellname"})[0];if(!h){l=d,c+=l+"_";break}}if(g(c+"spellname",o.name),s[0]&&"prepared"===s[0]&&g(c+"spellisprepared","on"),o.ritual&&g(c+"spellritual","{{spellritual=1}}"),o.concentration&&g(c+"spellconcentration","{{spellconcentration=1}}"),o.school&&g(c+"spellschool",o.school),o.castingTime&&("reaction"===o.castingTime?g(c+"spell_casting_time","@{spell_casting_time_reaction_var}"):"bonus"===o.castingTime?g(c+"spell_casting_time","@{spell_casting_time_bonus_var}"):"action"===o.castingTime?g(c+"spell_casting_time","@{spell_casting_time_action_var}"):"minute"===o.castingTime?g(c+"spell_casting_time","@{spell_casting_time_minute_var}"):(g(c+"spell_casting_time","@{spell_casting_time_longer_var}"),g(c+"spellcasttime",o.castingTime))),o.range&&g(c+"spellrange",o.range),o.target&&g(c+"spelltarget",o.target),o.aoe&&g(c+"spellaoe",o.aoe),o.components&&(o.components.verbal&&g(c+"spellcomponents_verbal","@{spellcomponents_verbal_var}"),o.components.somatic&&g(c+"spellcomponents_somatic","@{spellcomponents_somatic_var}"),o.components.material&&g(c+"spellcomponents_material","@{spellcomponents_material_var}"),o.components.materialMaterial&&g(c+"spellcomponents",o.components.materialMaterial)),o.duration&&g(c+"spellduration",o.duration),o.source&&g(c+"spellsource",o.source),o.description&&g(c+"spelldescription",o.description),o.higherLevel){g(c+"spellhighersloteffect",o.higherLevel);var _=!0;(o.attack&&o.attack.higherLevelDice||o.damage&&o.damage.higherLevelDice||o.save&&o.save.higherLevelDice||o.heal&&(o.heal.higherLevelDice||o.heal.higherLevelAmount))&&(_=!1),o.level>0&&_&&g(c+"spell_toggle_higher_lvl","@{spell_var_higher_lvl}")}if(o.emote){var p,u,m,f,v=getAttrByName(q,"gender","current");v&&v.match(/f|female|girl|woman|feminine/gi)?(p="she",u="her",m="her",f="herself"):(p="he",u="him",m="his",f="himself"),o.emote=o.emote.replace("{{GENDER_PRONOUN_HE_SHE}}",p).replace("{{GENDER_PRONOUN_HIM_HER}}",u).replace("{{GENDER_PRONOUN_HIS_HER}}",m).replace("{{GENDER_PRONOUN_HIMSELF_HERSELF}}",f),g(c+"spellemote",o.emote),g(c+"spell_toggle_emote","@{spell_var_emote}")}o.attack&&(g(c+"attackstat","@{casting_stat}"),g(c+"spell_toggle_attack","@{spell_var_attack}"),n(o.attack,"attack"),o.attack.damage&&g(c+"spell_toggle_attack_crit","@{spell_var_attack_crit}")),o.damage&&n(o.damage,"attack"),o.save&&(g(c+"spell_toggle_save","@{spell_var_save}"),o.save.condition&&g(c+"savecondition",o.save.condition),o.save.ability&&(g(c+"savestat",t(o.save.ability.substring(0,3))),g(c+"spellsavedc","@{casting_stat_dc}")),o.save.saveFailure&&g(c+"savefailure",o.save.saveFailure),o.save.saveSuccess&&g(c+"savesuccess",o.save.saveSuccess),n(o.save,"save")),o.heal&&(g(c+"spell_toggle_healing","@{spell_var_healing}"),g(c+"spellhealamount",o.heal.amount),o.heal.bonus&&g(c+"healbonus",o.heal.bonus),o.heal.castingStat&&g(c+"healstatbonus","@{casting_stat}"),(o.heal.higherLevelDice||o.heal.higherLevelAmount)&&g(c+"spell_toggle_higher_lvl_query","@{spell_var_higher_lvl_query}"),o.heal.higherLevelDice&&g(c+"spell_heal_higher_level_dmg_dice",o.heal.higherLevelDice),
o.heal.higherLevelDie&&g(c+"spell_heal_higher_level_dmg_die",o.heal.higherLevelDie),o.heal.higherLevelAmount&&g(c+"spell_heal_higher_level_amount",o.heal.higherLevelAmount)),o.effects&&(g(c+"spelleffect",o.effects),g(c+"spell_toggle_effects","@{spell_var_effects}"))},e.spellImport=function(t,a){var r=a[0].split(", "),s=t.get("represents"),n=findObjs({_type:"character",id:s})[0],o=[];z=getAttrByName(s,"character_name","current"),a[1]&&"prepared"===a[1]&&o.push("prepared");for(var l=0;l<r.length;l++)e.importSpell(n,z,r[l],o);i("Finished importing spells: "+r)},e.importMonster=function(t,a){var r=fifthMonsters.monsters.filter(function(e){return e.name.toLowerCase()===a.toLowerCase()})[0];if(z=r.name,!r)return void i('Error: cannot find a monster by the name of "'+a+'".');var c,h=findObjs({_type:"character",name:r.name});if(0===h.length?(h=createObj("character",{name:r.name,avatar:t.get("imgsrc")}),i(r.name+" created")):(h=getObj("character",h[0].id),i(r.name+" updated")),q=h.id,g("is_npc",1),r.name&&g("character_name",r.name),r.size&&g("size",r.size),r.type&&g("npc_type",r.type),r.alignment&&g("alignment",r.alignment),r.challenge&&L(r.challenge),r.AC&&w(r.AC),r.HP&&A(r.HP),r.speed&&O(r.speed),r.abilities&&b(r.abilities),r.savingThrows&&N(r.savingThrows),r.skills&&D(r.skills),r.senses&&T(r.senses),r.languages&&g("prolanguages",r.languages),r.damageResistances&&g("damage_resistance",r.damageResistances),r.damageVulnerabilities&&g("damage_vulnerability",r.damageVulnerabilities),r.damageImmunities&&g("damage_immunity",r.damageImmunities),r.conditionImmunities&&g("condition_immunity",r.conditionImmunities),e.settings.addInitiativeTokenAbility&&s(r.name),e.settings.addSaveQueryMacroTokenAbility&&n(r.name),e.settings.addCheckQueryMacroTokenAbility&&o(r.name),r.traits){g("toggle_traits","on");for(var _="",p=0;p<r.traits.length;p++)_+=r.traits[p].name+". "+r.traits[p].text+"\n";g("npc_traits",_)}if(r.actions){r.parsedActions={},g("toggle_actions","on");for(var p=0;p<r.actions.length;p++)r.parsedActions[r.actions[p].name]=r.actions[p].text;r.parsedActions.Multiattack&&(c=r.parsedActions.Multiattack,g("toggle_multiattack","on"),g("multiattack",c),d("MultiAtk","","%{"+z+"|multiattack}",e.settings.createAbilityAsToken),delete r.parsedActions.Multiattack);var u=I(r.parsedActions);if(c){for(var m,f,v=u.join("|"),y=new RegExp("(one|two|three)? (?:with its )?("+v+")( or)?","gi"),k="";f=y.exec(c);){var x=f[2],S=f[1]||"one";m=u.indexOf(x.toLowerCase()),-1!==m&&(k=j(m,k),"two"==S&&(k=j(m,k)),"three"==S&&(k=j(m,k)),f[3]&&(k+="or\n"),delete u[m])}g("multiattack_script",k)}}if(r.legendaryActions){r.parsedLegendaryActions={},g("toggle_legendary_actions","on");for(var p=0;p<r.legendaryActions.length;p++)r.parsedActions[r.legendaryActions[p].name]=r.legendaryActions[p].text;I(r.parsedLegendaryActions,"legendary_")}if(r.lairActions){r.parsedLairActions={},g("toggle_lair_actions","on");for(var p=0;p<r.parsedLairActions.length;p++)r.parsedActions[r.parsedLairActions[p].name]=r.parsedLairActions[p].text;I(r.parsedLairActions,"lair_")}if(q&&(t.set("represents",q),e.settings.useAaronsNumberedScript&&1!==z.indexOf("%%NUMBERED%%")&&(r.name+=" %%NUMBERED%%"),t.set("name",r.name),e.settings.showName&&t.set("showname",!0),e.settings.showNameToPlayers&&t.set("showplayers_name",!0),l(),H(t),e.settings.bar[0].show&&t.set("showplayers_bar1","true"),e.settings.bar[1].show&&t.set("showplayers_bar2","true"),e.settings.bar[2].show&&t.set("showplayers_bar3","true"),C(t)),r.traits){if(r.traits){for(var E="",M=/(?:(?:\d+\/day(?:\s* each)?)|(?:At will)|(?:(?:Cantrips|level)(?:\s*\(.*\))?)):\s* (.*)/gi,p=0;p<r.traits.length;p++)for(var f;f=M.exec(r.traits[p]);)f&&(""!==E&&(E+=", "),E+=f[1].replace(/\s*\(self only\)/gi,"").replace(/\s*\(self\)/gi,"").replace(/\s*\(\d+(?:st|nd|rd|th)\s*level\)/gi,""));""!==E&&e.spellImport(t,[E])}}else r.spells&&e.spellImport(t,[r.spells])},e.monsterImport=function(a,i){var r=t(i[0]);i[1]&&"clean"===i[1]&&e.deleteOldSheetByName(r),e.importMonster(a,r)}}("undefined"==typeof shaped?shaped={}:shaped),on("ready",function(){"use strict";shaped.statblock.RegisterHandlers()});